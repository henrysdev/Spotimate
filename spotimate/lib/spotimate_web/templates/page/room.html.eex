<!doctype html>
<html>
  <head>
    <title>Spotimate - <%= @room_name %></title>
    <link rel="stylesheet" href="https://unpkg.com/purecss@1.0.1/build/pure-min.css"
        integrity="sha384-oAOxQR6DkCoMliIh8yFnu25d7Eq/PHS21PClpwjOTeU2jRSq11vu66rf90/cZr47"
        crossorigin="anonymous">
    <script>
      function sync_playhead(device_id) {
        var CSRF_TOKEN = <%= raw Poison.encode!(Plug.CSRFProtection.get_csrf_token()) %>;
        const Http = new XMLHttpRequest();
        const url='http://localhost:4000/api/room/listen';
        const params=`device_id=${device_id}`
        Http.open("POST", url, true);
        Http.responseType = 'json';
        Http.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
        Http.setRequestHeader('X-CSRF-Token', CSRF_TOKEN);
        Http.send(params);
        return Http;
      }
      function fetch_playhead(device_id) {
        function play_loop() {
          Http = sync_playhead(device_id);
          Http.onreadystatechange = function() {
            if (this.readyState == 4) {
              const jsonResp = JSON.parse(Http.response);
              const deadline_utc = jsonResp['deadline_utc'];
              const now = Date.now();
              let remaining_ms = deadline_utc - now

              // If deadline exceeded, check again every second
              if (remaining_ms <= 0) {
                remaining_ms = 1000;
              }
              console.log("deadline_utc: ", deadline_utc);
              console.log("remaining_ms: ", remaining_ms);
              
              // Wait remaining time of song to update playhead
              setTimeout(
                () => play_loop(),
              remaining_ms);
            }
          }
        }
        return play_loop();
      }
    </script>
  </head>
  <body>

    <script src="https://sdk.scdn.co/spotify-player.js"></script>


    <script>
      window.onSpotifyWebPlaybackSDKReady = () => {
        const token = 'BQChV-7oruE6ErOAzYVWTbDEHyKxeS1dUnhWVtQHS0J-pugzVl3KrOVwabqfIBHxZBGxqIs8OwTHFH6L3xUZWJLN8mA3pI0FPdgf-5hmtNWwKZyqDcwV0WHdERaMhK7CP5U9hq-jD8fJp2FIYUqtz26NOCLx2slE-JekwQTAC8RQ';
        const player = new Spotify.Player({
          name: 'Web Playback SDK Quick Start Player',
          getOAuthToken: cb => { cb(token); }
        });

        // Error handling
        player.addListener('initialization_error', ({ message }) => { console.error(message); });
        player.addListener('authentication_error', ({ message }) => { console.error(message); });
        player.addListener('account_error', ({ message }) => { console.error(message); });
        player.addListener('playback_error', ({ message }) => { console.error(message); });

        // Playback status updates
        player.addListener('player_state_changed', state => { console.log(state); });

        // Ready
        player.addListener('ready', ({ device_id }) => {
          console.log('Ready with Device ID', device_id);
        });

        // Not Ready
        player.addListener('not_ready', ({ device_id }) => {
          console.log('Device ID has gone offline', device_id);
        });

        // Connect to the player!
        player.connect();
      };
    </script>

    <script>
    window.onSpotifyWebPlaybackSDKReady = () => {
      const token = "<%= raw @access_token %>";
      const player = new Spotify.Player({
        name: 'Web Playback SDK Quick Start Player',
        getOAuthToken: cb => { cb(token); }
      });

      // Error handling
      player.addListener('initialization_error', ({ message }) => { console.error(message); });
      player.addListener('authentication_error', ({ message }) => { console.error(message); });
      player.addListener('account_error', ({ message }) => { console.error(message); });
      //player.addListener('playback_error', ({ message }) => { console.error(message); });

      // Playback status updates
      player.addListener('player_state_changed', state => { console.log(state); });

      // Ready
      player.addListener('ready', ({ device_id }) => {
        fetch_playhead(device_id);

        var player = new Spotify.Player({
          name: 'Spotimate Player',
          getOAuthToken: callback => {
            // Run code to get a fresh access token
            callback("<%= raw @access_token %>");
          },
          volume: 0.5
        });

        player.connect();

        player.resume();
      });

      // Connect to the player!
      player.connect();

      // Resume playing
      player.resume();
    };
  </script>
  </body>
</html>